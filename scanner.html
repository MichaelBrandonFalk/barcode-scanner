<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barcode Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 12px; }
    video, img, canvas { width: 100%; border-radius: 12px; background: #111; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button, input[type="file"] { font-size: 16px; }
    button {
      padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer;
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .status { margin-top: 10px; color: #111; }
    .code { margin-top: 10px; font-size: 18px; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 8px; }
    .hint { margin-top: 10px; color: #444; font-size: 14px; line-height: 1.35; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Scan a barcode</h1>

  <div class="card">
    <div id="status" class="status">Checking support...</div>

    <video id="video" class="hidden" playsinline muted></video>
    <img id="preview" class="hidden" alt="Uploaded image preview" />
    <canvas id="canvas" class="hidden"></canvas>

    <div class="row">
      <button id="startBtn">Use camera</button>
      <button id="stopBtn" class="hidden">Stop</button>

      <label style="display:inline-block;">
        <input id="fileInput" type="file" accept="image/*" style="display:none;" />
        <button id="uploadBtn" type="button">Upload photo</button>
      </label>
    </div>

    <div class="code">
      Barcode: <code id="code">none</code>
    </div>

    <div class="hint">
      Tips: fill the frame with the barcode, avoid glare, hold steady. If camera scanning fails, try Upload photo.
      Works best in Chrome or Edge on Android and requires HTTPS.
    </div>
  </div>

<script>
(() => {
  // 1) Paste your Custom GPT link here
  const GPT_LINK = "https://chatgpt.com/g/g-69668ac831dc81918be724f6ba3eee8d-the-wonderful-chef";

  // Behavior
  const AUTO_OPEN_GPT_AFTER_DETECT = true;
  const OPEN_DELAY_MS = 250;

  // Throttle scanning
  const SCAN_INTERVAL_MS = 220;

  const statusEl = document.getElementById("status");
  const codeEl = document.getElementById("code");

  const video = document.getElementById("video");
  const preview = document.getElementById("preview");
  const canvas = document.getElementById("canvas");

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");

  let detector = null;
  let stream = null;
  let timerId = null;
  let lastCode = null;

  function setStatus(msg) { statusEl.textContent = msg; }

  function normalizeDigits(s) {
    return String(s || "").replace(/\D+/g, "");
  }

  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }

  function stopLoop() {
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  function stopCamera() {
    stopLoop();
    if (video) video.pause();
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    hide(video);
    hide(stopBtn);
    setStatus("Stopped.");
  }

  async function ensureDetector() {
    if (!window.isSecureContext) {
      setStatus("This page must be served over HTTPS.");
      return null;
    }
    if (!("BarcodeDetector" in window)) {
      setStatus("BarcodeDetector not supported in this browser. Try Chrome or Edge on Android.");
      return null;
    }

    // Try to select common retail formats
    let formats = [];
    try { formats = await BarcodeDetector.getSupportedFormats(); } catch {}

    const preferred = ["ean_13", "ean_8", "upc_a", "upc_e"];
    const chosen = formats && formats.length ? preferred.filter(f => formats.includes(f)) : preferred;

    detector = new BarcodeDetector({ formats: chosen });
    return detector;
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      return false;
    }
  }

  function openGpt() {
    if (!AUTO_OPEN_GPT_AFTER_DETECT) return;

    if (!GPT_LINK || GPT_LINK.includes("PASTE_YOUR_CUSTOM_GPT_LINK_HERE")) {
      setStatus("Set GPT_LINK in the file first.");
      return;
    }

    // Open in a new tab so user can come back if needed
    window.open(GPT_LINK, "_blank", "noopener,noreferrer");
  }

  async function handleFound(rawValue) {
    const digits = normalizeDigits(rawValue);
    if (!digits) return;

    lastCode = digits;
    codeEl.textContent = digits;

    if (navigator.vibrate) navigator.vibrate(80);

    const copied = await copyToClipboard(digits);
    if (copied) {
      setStatus("Found and copied. Opening your GPT...");
    } else {
      setStatus("Found barcode. Copy may be blocked, long press the digits to copy. Opening your GPT...");
    }

    stopLoop();
    stopCamera();

    setTimeout(openGpt, OPEN_DELAY_MS);
  }

  async function scanVideoFrame() {
    if (!detector || !video || video.readyState < 2 || lastCode) return;

    try {
      const results = await detector.detect(video);
      if (results && results.length) {
        const candidates = results
          .map(r => normalizeDigits(r.rawValue))
          .filter(Boolean)
          .sort((a, b) => b.length - a.length);

        if (candidates.length) {
          await handleFound(candidates[0]);
        }
      }
    } catch {
      // ignore intermittent errors
    }
  }

  function startLoop() {
    stopLoop();
    timerId = setInterval(scanVideoFrame, SCAN_INTERVAL_MS);
  }

  async function startCamera() {
    lastCode = null;
    codeEl.textContent = "none";
    hide(preview);
    hide(canvas);

    const d = await ensureDetector();
    if (!d) return;

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
    } catch {
      setStatus("Camera permission denied or not available.");
      return;
    }

    video.srcObject = stream;
    await video.play();

    show(video);
    show(stopBtn);

    setStatus("Scanning with camera...");
    startLoop();
  }

  async function scanUploadedImage(file) {
  lastCode = null;
  codeEl.textContent = "none";
  stopCamera();

  const d = await ensureDetector();
  if (!d) return;

  hide(video);
  hide(canvas);
  hide(preview);

  setStatus("Scanning uploaded photo...");

  // Helper: run detect on a canvas
  async function detectOnCanvas(c) {
    try {
      const results = await detector.detect(c);
      if (!results || !results.length) return null;

      const candidates = results
        .map(r => normalizeDigits(r.rawValue))
        .filter(Boolean)
        .sort((a, b) => b.length - a.length);

      return candidates.length ? candidates[0] : null;
    } catch {
      return null;
    }
  }

  // Helper: draw crop (sx,sy,sw,sh) of bitmap onto canvas, with optional contrast boost
  function drawCrop(bitmap, sx, sy, sw, sh, contrastBoost) {
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    canvas.width = Math.max(1, Math.floor(sw));
    canvas.height = Math.max(1, Math.floor(sh));

    ctx.drawImage(bitmap, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

    if (contrastBoost) {
      // simple contrast boost: map pixels around mid point
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;

      // Contrast factor: 1.0 no change, 1.3 to 1.8 often helps
      const factor = 1.6;
      const intercept = 128 * (1 - factor);

      for (let i = 0; i < data.length; i += 4) {
        // luminance-ish grayscale then reapply
        const r = data[i], g = data[i + 1], b = data[i + 2];
        const y = 0.2126 * r + 0.7152 * g + 0.0722 * b;

        const y2 = Math.max(0, Math.min(255, factor * y + intercept));
        data[i] = data[i + 1] = data[i + 2] = y2;
        // alpha stays
      }
      ctx.putImageData(imgData, 0, 0);
    }
  }

  try {
    const bitmap = await createImageBitmap(file);

    // Show preview for user context (optional)
    const url = URL.createObjectURL(file);
    preview.src = url;
    show(preview);

    const w = bitmap.width;
    const h = bitmap.height;

    // Build crop candidates: full, center, lower center (common barcode zone)
    const crops = [
      { name: "full", sx: 0, sy: 0, sw: w, sh: h },
      { name: "center", sx: w * 0.15, sy: h * 0.15, sw: w * 0.70, sh: h * 0.70 },
      { name: "lower", sx: w * 0.10, sy: h * 0.45, sw: w * 0.80, sh: h * 0.50 },
      { name: "lower-tight", sx: w * 0.15, sy: h * 0.55, sw: w * 0.70, sh: h * 0.35 }
    ];

    // Try crops without and with contrast boost
    for (const pass of [false, true]) {
      for (const c of crops) {
        drawCrop(bitmap, c.sx, c.sy, c.sw, c.sh, pass);
        show(canvas);

        const code = await detectOnCanvas(canvas);
        if (code) {
          URL.revokeObjectURL(url);
          await handleFound(code);
          return;
        }
      }
    }

    URL.revokeObjectURL(url);
    setStatus("No barcode found. Try a closer, sharper photo with the barcode filling the frame and less glare.");
  } catch {
    setStatus("Could not scan that image. Try another photo or use camera scan.");
  }
}


      // Fallback: draw to canvas and try again (helps on some devices)
      const ctx = canvas.getContext("2d");
      canvas.width = preview.naturalWidth || preview.width;
      canvas.height = preview.naturalHeight || preview.height;
      ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);

      show(canvas);
      const results2 = await detector.detect(canvas);
      if (results2 && results2.length) {
        const candidates2 = results2
          .map(r => normalizeDigits(r.rawValue))
          .filter(Boolean)
          .sort((a, b) => b.length - a.length);

        if (candidates2.length) {
          await handleFound(candidates2[0]);
          URL.revokeObjectURL(url);
          return;
        }
      }

      setStatus("No barcode found. Try a clearer photo or use camera scan with less glare.");
      URL.revokeObjectURL(url);
    } catch {
      setStatus("Could not scan that image. Try another photo or use camera scan.");
      URL.revokeObjectURL(url);
    }
  }

  // Event wiring
  startBtn.addEventListener("click", startCamera);
  stopBtn.addEventListener("click", stopCamera);

  uploadBtn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    await scanUploadedImage(file);
    fileInput.value = "";
  });

  // Initial checks
  (async () => {
    if (!window.isSecureContext) {
      setStatus("This page must be served over HTTPS.");
      return;
    }
    if (!("BarcodeDetector" in window)) {
      setStatus("BarcodeDetector not supported here. Try Chrome or Edge on Android.");
      return;
    }
    setStatus("Ready. Use camera or upload a photo.");
  })();
})();
</script>
</body>
</html>

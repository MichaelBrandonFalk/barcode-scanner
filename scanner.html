<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barcode Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 12px; }
    video, img { width: 100%; border-radius: 12px; background: #111; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 16px; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .status { margin-top: 10px; color: #111; }
    .code { margin-top: 10px; font-size: 18px; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 8px; }
    .hint { margin-top: 10px; color: #444; font-size: 14px; line-height: 1.35; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Scan a barcode</h1>

  <div class="card">
    <div id="status" class="status">Checking support...</div>

    <video id="video" class="hidden" playsinline muted></video>
    <img id="preview" class="hidden" alt="Uploaded image preview" />

    <div class="row">
      <button id="cameraBtn">Use camera</button>
      <button id="stopBtn" class="hidden">Stop</button>

      <input id="fileInput" type="file" accept="image/*" class="hidden" />
      <button id="uploadBtn" type="button">Upload photo</button>
    </div>

    <div class="code">
      Barcode: <code id="code">none</code>
    </div>

    <div class="hint">
      Tips: fill the frame with the barcode, avoid glare, hold steady.
      If upload scan fails, crop the photo tighter around the barcode and try again.
      Works best in Chrome or Edge on Android and requires HTTPS.
    </div>
  </div>

<script>
(() => {
  // Your Custom GPT link
  const GPT_LINK = "https://chatgpt.com/g/g-69668ac831dc81918be724f6ba3eee8d-the-wonderful-chef";

  // Behavior
  const AUTO_OPEN_GPT_AFTER_DETECT = true;
  const OPEN_DELAY_MS = 250;

  // Camera scanning throttle
  const SCAN_INTERVAL_MS = 220;

  const statusEl = document.getElementById("status");
  const codeEl = document.getElementById("code");

  const video = document.getElementById("video");
  const preview = document.getElementById("preview");

  const cameraBtn = document.getElementById("cameraBtn");
  const stopBtn = document.getElementById("stopBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");

  // Hidden work canvas (never shown)
  const workCanvas = document.createElement("canvas");
  const workCtx = workCanvas.getContext("2d", { willReadFrequently: true });

  let detector = null;
  let stream = null;
  let timerId = null;
  let lastCode = null;

  function setStatus(msg) { statusEl.textContent = msg; }
  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }

  function normalizeDigits(s) {
    return String(s || "").replace(/\D+/g, "");
  }

  function stopLoop() {
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  function resetResult() {
    lastCode = null;
    codeEl.textContent = "none";
  }

  function stopCamera() {
    stopLoop();
    if (video) video.pause();
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    hide(video);
    hide(stopBtn);
  }

  async function ensureDetector() {
    if (!window.isSecureContext) {
      setStatus("This page must be served over HTTPS.");
      return null;
    }
    if (!("BarcodeDetector" in window)) {
      setStatus("BarcodeDetector not supported in this browser. Try Chrome or Edge on Android.");
      return null;
    }

    // Prefer common retail formats
    let formats = [];
    try { formats = await BarcodeDetector.getSupportedFormats(); } catch {}

    const preferred = ["ean_13", "ean_8", "upc_a", "upc_e"];
    const chosen = formats && formats.length ? preferred.filter(f => formats.includes(f)) : preferred;

    detector = new BarcodeDetector({ formats: chosen });
    return detector;
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      return false;
    }
  }

  function openGpt() {
    if (!AUTO_OPEN_GPT_AFTER_DETECT) return;
    if (!GPT_LINK) return;
    window.open(GPT_LINK, "_blank", "noopener,noreferrer");
  }

  async function handleFound(rawValue) {
    const digits = normalizeDigits(rawValue);
    if (!digits) return;

    lastCode = digits;
    codeEl.textContent = digits;

    if (navigator.vibrate) navigator.vibrate(80);

    const copied = await copyToClipboard(digits);
    setStatus(copied ? "Found and copied. Opening your GPT..." : "Found barcode. Copy may be blocked. Opening your GPT...");

    stopLoop();
    stopCamera();

    setTimeout(openGpt, OPEN_DELAY_MS);
  }

  async function detectOnCanvas() {
    try {
      const results = await detector.detect(workCanvas);
      if (!results || !results.length) return null;

      const candidates = results
        .map(r => normalizeDigits(r.rawValue))
        .filter(Boolean)
        .sort((a, b) => b.length - a.length);

      return candidates.length ? candidates[0] : null;
    } catch {
      return null;
    }
  }

  function drawCrop(bitmap, sx, sy, sw, sh, outMaxSide) {
    // scale crop so barcode lines have enough pixels
    const scale = outMaxSide / Math.max(sw, sh);
    const dw = Math.max(1, Math.floor(sw * scale));
    const dh = Math.max(1, Math.floor(sh * scale));

    workCanvas.width = dw;
    workCanvas.height = dh;

    workCtx.drawImage(bitmap, sx, sy, sw, sh, 0, 0, dw, dh);
  }

  function grayscaleContrastBoost() {
    // Simple grayscale + contrast boost that often helps on slightly blurry uploads
    const imgData = workCtx.getImageData(0, 0, workCanvas.width, workCanvas.height);
    const data = imgData.data;

    // Contrast factor: 1.0 no change, higher increases contrast
    const factor = 1.7;
    const intercept = 128 * (1 - factor);

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i + 1], b = data[i + 2];
      const y = 0.2126 * r + 0.7152 * g + 0.0722 * b;

      let y2 = factor * y + intercept;
      if (y2 < 0) y2 = 0;
      if (y2 > 255) y2 = 255;

      data[i] = data[i + 1] = data[i + 2] = y2;
    }
    workCtx.putImageData(imgData, 0, 0);
  }

  async function scanBitmapWithCrops(bitmap) {
    const w = bitmap.width;
    const h = bitmap.height;

    // Try several likely regions. Barcodes are often on the lower half.
    const crops = [
      { sx: 0,       sy: 0,        sw: w,        sh: h },        // full
      { sx: w*0.10,  sy: h*0.40,   sw: w*0.80,   sh: h*0.60 },   // lower
      { sx: w*0.15,  sy: h*0.50,   sw: w*0.70,   sh: h*0.45 },   // lower tight
      { sx: w*0.15,  sy: h*0.15,   sw: w*0.70,   sh: h*0.70 },   // center
    ];

    // Two passes: raw then contrast boosted
    for (const pass of ["raw", "boost"]) {
      for (const c of crops) {
        drawCrop(bitmap, c.sx, c.sy, c.sw, c.sh, 1400);

        if (pass === "boost") grayscaleContrastBoost();

        const code = await detectOnCanvas();
        if (code) return code;
      }
    }

    return null;
  }

  async function scanVideoFrame() {
    if (!detector || !video || video.readyState < 2 || lastCode) return;

    try {
      const results = await detector.detect(video);
      if (results && results.length) {
        const candidates = results
          .map(r => normalizeDigits(r.rawValue))
          .filter(Boolean)
          .sort((a, b) => b.length - a.length);

        if (candidates.length) {
          await handleFound(candidates[0]);
        }
      }
    } catch {
      // ignore intermittent errors
    }
  }

  async function startCamera() {
    resetResult();
    hide(preview);

    const d = await ensureDetector();
    if (!d) return;

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });
    } catch {
      setStatus("Camera permission denied or not available.");
      return;
    }

    video.srcObject = stream;
    await video.play();

    show(video);
    show(stopBtn);

    // Give autofocus a moment before scanning starts
    await new Promise(r => setTimeout(r, 350));

    setStatus("Scanning with camera...");
    stopLoop();
    timerId = setInterval(scanVideoFrame, SCAN_INTERVAL_MS);
  }

  async function scanUploadedImage(file) {
    resetResult();
    stopCamera();

    const d = await ensureDetector();
    if (!d) return;

    setStatus("Loading uploaded photo...");

    // Show only the preview image (no canvas shown)
    const url = URL.createObjectURL(file);
    preview.src = url;
    show(preview);
    hide(video);
    hide(stopBtn);

    try {
      const bitmap = await createImageBitmap(file);

      setStatus("Scanning uploaded photo...");

      const code = await scanBitmapWithCrops(bitmap);

      URL.revokeObjectURL(url);

      if (code) {
        await handleFound(code);
      } else {
        setStatus("No barcode found. Try a closer, sharper photo with less glare, or crop tighter around the barcode.");
      }
    } catch {
      URL.revokeObjectURL(url);
      setStatus("Could not scan that image. Try another photo or use camera scan.");
    }
  }

  // Events
  cameraBtn.addEventListener("click", startCamera);

  stopBtn.addEventListener("click", () => {
    stopCamera();
    setStatus("Stopped.");
  });

  uploadBtn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    await scanUploadedImage(file);
    fileInput.value = "";
  });

  // Initial
  (async () => {
    if (!window.isSecureContext) {
      setStatus("This page must be served over HTTPS.");
      return;
    }
    if (!("BarcodeDetector" in window)) {
      setStatus("BarcodeDetector not supported here. Try Chrome or Edge on Android.");
      return;
    }
    setStatus("Ready. Use camera or upload a photo.");
  })();
})();
</script>
</body>
</html>

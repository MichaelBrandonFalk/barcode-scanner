<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barcode Scanner</title>

  <!-- OCR fallback (free, runs in the browser) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 12px; }
    video, img { width: 100%; border-radius: 12px; background: #111; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 16px; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .status { margin-top: 10px; color: #111; }
    .code { margin-top: 10px; font-size: 18px; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 8px; }
    .hint { margin-top: 10px; color: #444; font-size: 14px; line-height: 1.35; }
    .hidden { display: none; }
  </style>
</head>

<body>
  <h1>Scan a barcode</h1>

  <div class="card">
    <div id="status" class="status">Checking support...</div>

    <video id="video" class="hidden" playsinline muted></video>
    <img id="preview" class="hidden" alt="Uploaded image preview" />

    <div class="row">
      <button id="cameraBtn">Use camera</button>
      <button id="stopBtn" class="hidden">Stop</button>

      <input id="fileInput" type="file" accept="image/*" class="hidden" />
      <button id="uploadBtn" type="button">Upload photo</button>
    </div>

    <div class="code">
      Barcode: <code id="code">none</code>
    </div>

    <div class="hint">
      If upload scan fails, try cropping the photo tighter around the barcode and upload again.
      Best results: barcode fills the frame, minimal glare, and the label is flat.
    </div>
  </div>

<script>
(() => {
  // Set this to your Custom GPT link (already in your repo, included here for completeness)
  const GPT_LINK = "https://chatgpt.com/g/g-69668ac831dc81918be724f6ba3eee8d-the-wonderful-chef";

  const AUTO_OPEN_GPT_AFTER_DETECT = true;
  const OPEN_DELAY_MS = 250;
  const SCAN_INTERVAL_MS = 220;

  const statusEl = document.getElementById("status");
  const codeEl = document.getElementById("code");

  const video = document.getElementById("video");
  const preview = document.getElementById("preview");

  const cameraBtn = document.getElementById("cameraBtn");
  const stopBtn = document.getElementById("stopBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");

  // Hidden work canvas (never displayed)
  const workCanvas = document.createElement("canvas");
  const workCtx = workCanvas.getContext("2d", { willReadFrequently: true });

  let detector = null;
  let stream = null;
  let timerId = null;
  let lastCode = null;

  function setStatus(msg) { statusEl.textContent = msg; }
  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }

  function normalizeDigits(s) {
    return String(s || "").replace(/\D+/g, "");
  }

  function resetResult() {
    lastCode = null;
    codeEl.textContent = "none";
  }

  function stopLoop() {
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  function stopCamera() {
    stopLoop();
    if (video) video.pause();
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    hide(video);
    hide(stopBtn);
  }

  async function ensureDetector() {
    if (!window.isSecureContext) {
      setStatus("This page must be served over HTTPS.");
      return null;
    }
    if (!("BarcodeDetector" in window)) {
      setStatus("BarcodeDetector not supported in this browser. Try Chrome or Edge on Android.");
      return null;
    }

    let formats = [];
    try { formats = await BarcodeDetector.getSupportedFormats(); } catch {}

    const preferred = ["ean_13", "ean_8", "upc_a", "upc_e"];
    const chosen = formats && formats.length ? preferred.filter(f => formats.includes(f)) : preferred;

    detector = new BarcodeDetector({ formats: chosen });
    return detector;
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      return false;
    }
  }

  function openGpt() {
    if (!AUTO_OPEN_GPT_AFTER_DETECT) return;
    if (!GPT_LINK) return;
    window.open(GPT_LINK, "_blank", "noopener,noreferrer");
  }

  async function handleFound(rawValue) {
    const digits = normalizeDigits(rawValue);
    if (!digits) return;

    lastCode = digits;
    codeEl.textContent = digits;

    if (navigator.vibrate) navigator.vibrate(80);

    const copied = await copyToClipboard(digits);
    if (copied) setStatus("Found and copied. Opening your GPT...");
    else setStatus("Found barcode. Copy may be blocked. Opening your GPT...");

    stopLoop();
    stopCamera();

    setTimeout(openGpt, OPEN_DELAY_MS);
  }

  async function detectOnCanvas() {
    try {
      const results = await detector.detect(workCanvas);
      if (!results || !results.length) return null;

      const candidates = results
        .map(r => normalizeDigits(r.rawValue))
        .filter(Boolean)
        .sort((a, b) => b.length - a.length);

      return candidates.length ? candidates[0] : null;
    } catch {
      return null;
    }
  }

  function drawCrop(bitmap, sx, sy, sw, sh, outMaxSide) {
    const scale = outMaxSide / Math.max(sw, sh);
    const dw = Math.max(1, Math.floor(sw * scale));
    const dh = Math.max(1, Math.floor(sh * scale));

    workCanvas.width = dw;
    workCanvas.height = dh;
    workCtx.drawImage(bitmap, sx, sy, sw, sh, 0, 0, dw, dh);
  }

  function grayscaleContrastBoost() {
    const imgData = workCtx.getImageData(0, 0, workCanvas.width, workCanvas.height);
    const data = imgData.data;

    const factor = 1.7;
    const intercept = 128 * (1 - factor);

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i + 1], b = data[i + 2];
      const y = 0.2126 * r + 0.7152 * g + 0.0722 * b;

      let y2 = factor * y + intercept;
      if (y2 < 0) y2 = 0;
      if (y2 > 255) y2 = 255;

      data[i] = data[i + 1] = data[i + 2] = y2;
    }

    workCtx.putImageData(imgData, 0, 0);
  }

  async function scanBitmapWithCrops(bitmap) {
    const w = bitmap.width;
    const h = bitmap.height;

    // Heavily favor the lower portion where barcodes usually are
    const crops = [
      { sx: 0,       sy: 0,        sw: w,        sh: h },        // full
      { sx: w*0.08,  sy: h*0.38,   sw: w*0.84,   sh: h*0.62 },   // lower
      { sx: w*0.12,  sy: h*0.50,   sw: w*0.76,   sh: h*0.45 },   // lower tighter
      { sx: w*0.18,  sy: h*0.58,   sw: w*0.64,   sh: h*0.35 },   // barcode + digits band
      { sx: w*0.15,  sy: h*0.15,   sw: w*0.70,   sh: h*0.70 },   // center
    ];

    for (const pass of ["raw", "boost"]) {
      for (const c of crops) {
        drawCrop(bitmap, c.sx, c.sy, c.sw, c.sh, 1600);
        if (pass === "boost") grayscaleContrastBoost();

        const code = await detectOnCanvas();
        if (code) return code;
      }
    }

    return null;
  }

  // Check digit validation (helps OCR choose the right digits)
  function isValidUpcA(code) {
    if (!/^\d{12}$/.test(code)) return false;
    const d = code.split("").map(Number);
    let sumOdd = 0, sumEven = 0;
    for (let i = 0; i < 11; i++) {
      if ((i % 2) === 0) sumOdd += d[i];
      else sumEven += d[i];
    }
    const check = (10 - ((sumOdd * 3 + sumEven) % 10)) % 10;
    return check === d[11];
  }

  function isValidEan13(code) {
    if (!/^\d{13}$/.test(code)) return false;
    const d = code.split("").map(Number);
    let sum = 0;
    for (let i = 0; i < 12; i++) sum += d[i] * (i % 2 === 0 ? 1 : 3);
    const check = (10 - (sum % 10)) % 10;
    return check === d[12];
  }

  function looksValidBarcode(code) {
    if (isValidUpcA(code)) return true;
    if (isValidEan13(code)) return true;
    if (/^\d{8}$/.test(code)) return true; // accept EAN-8 without check digit verification
    return false;
  }

  async function ocrDigitsFromLowerRegion(bitmap) {
    if (typeof Tesseract === "undefined") return "";

    // Crop a band where the printed digits usually are
    const w = bitmap.width;
    const h = bitmap.height;

    const sx = Math.floor(w * 0.08);
    const sy = Math.floor(h * 0.58);
    const sw = Math.floor(w * 0.84);
    const sh = Math.floor(h * 0.32);

    workCanvas.width = sw;
    workCanvas.height = sh;
    workCtx.drawImage(bitmap, sx, sy, sw, sh, 0, 0, sw, sh);

    // Binarize to help OCR
    const imgData = workCtx.getImageData(0, 0, sw, sh);
    const data = imgData.data;
    for (let i = 0; i < data.length; i += 4) {
      const y = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];
      const v = y > 165 ? 255 : 0;
      data[i] = data[i + 1] = data[i + 2] = v;
    }
    workCtx.putImageData(imgData, 0, 0);

    // OCR digits only
    const result = await Tesseract.recognize(workCanvas, "eng", {
      tessedit_char_whitelist: "0123456789",
    });

    const text = (result && result.data && result.data.text) ? result.data.text : "";
    const digits = text.replace(/\D+/g, "");
    if (!digits) return "";

    // Pull likely codes out of OCR stream
    const candidates = [];
    for (const len of [13, 12, 8]) {
      for (let i = 0; i + len <= digits.length; i++) {
        candidates.push(digits.slice(i, i + len));
      }
    }

    // Prefer valid check digit
    const valid = candidates.find(looksValidBarcode);
    return valid || (candidates[0] || "");
  }

  async function scanVideoFrame() {
    if (!detector || !video || video.readyState < 2 || lastCode) return;

    try {
      const results = await detector.detect(video);
      if (results && results.length) {
        const candidates = results
          .map(r => normalizeDigits(r.rawValue))
          .filter(Boolean)
          .sort((a, b) => b.length - a.length);

        if (candidates.length) await handleFound(candidates[0]);
      }
    } catch {
      // ignore intermittent errors
    }
  }

  async function startCamera() {
    resetResult();
    hide(preview);

    const d = await ensureDetector();
    if (!d) return;

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });
    } catch {
      setStatus("Camera permission denied or not available.");
      return;
    }

    video.srcObject = stream;
    await video.play();

    show(video);
    show(stopBtn);

    // Give autofocus a moment
    await new Promise(r => setTimeout(r, 350));

    setStatus("Scanning with camera...");
    stopLoop();
    timerId = setInterval(scanVideoFrame, SCAN_INTERVAL_MS);
  }

  async function scanUploadedImage(file) {
    resetResult();
    stopCamera();

    const d = await ensureDetector();
    if (!d) return;

    const url = URL.createObjectURL(file);
    preview.src = url;
    show(preview);
    hide(video);
    hide(stopBtn);

    setStatus("Loading uploaded photo...");

    try {
      const bitmap = await createImageBitmap(file);

      setStatus("Scanning barcode bars...");
      let code = await scanBitmapWithCrops(bitmap);

      if (!code) {
        setStatus("No barcode from bars. Reading printed digits...");
        code = await ocrDigitsFromLowerRegion(bitmap);
      }

      URL.revokeObjectURL(url);

      if (code) {
        await handleFound(code);
      } else {
        setStatus("No barcode found. Try a closer photo, less glare, or crop tighter around the barcode.");
      }
    } catch {
      URL.revokeObjectURL(url);
      setStatus("Could not scan that image. Try another photo or use camera scan.");
    }
  }

  // Events
  cameraBtn.addEventListener("click", startCamera);

  stopBtn.addEventListener("click", () => {
    stopCamera();
    setStatus("Stopped.");
  });

  uploadBtn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    await scanUploadedImage(file);
    fileInput.value = "";
  });

  // Initial
  (async () => {
    if (!window.isSecureContext) {
      setStatus("This page must be served over HTTPS.");
      return;
    }
    if (!("BarcodeDetector" in window)) {
      setStatus("BarcodeDetector not supported here. Try Chrome or Edge on Android.");
      return;
    }
    setStatus("Ready. Use camera or upload a photo.");
  })();
})();
</script>
</body>
</html>
